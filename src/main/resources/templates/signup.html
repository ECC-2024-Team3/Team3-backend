<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
  <title>Sign Up</title>
</head>
<body>
<div layout:fragment="content" class="container my-3">
  <div class="my-3 border-bottom">
    <h1>Sign Up</h1>
  </div>
  <!-- íšŒì›ê°€ì… í¼ -->
  <form th:action="@{/user/signup}" th:object="${userCreateForm}" method="post">
    <!-- ğŸ›‘ ì•„ì´ë”” ì¤‘ë³µ ë° ê¸°íƒ€ ê¸€ë¡œë²Œ ì—ëŸ¬ ë©”ì‹œì§€ -->
    <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger">
      <p th:each="err : ${#fields.globalErrors()}" th:text="${err}"></p>
    </div>

    <div class="mb-3">
      <label for="username" class="form-label">Username</label>
      <input type="text" id="username" th:field="*{username}" class="form-control">

      <!-- ğŸ›‘ username ì¤‘ë³µ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ -->
      <div th:if="${#fields.hasErrors('username')}" class="alert alert-danger">
        <p th:errors="*{username}"></p>
      </div>
    </div>
    <div class="mb-3">
      <label for="password1" class="form-label">Password</label>
      <input type="password" id="password1" th:field="*{password1}" class="form-control">
    </div>
    <div class="mb-3">
      <label for="password2" class="form-label">Confirm Password</label>
      <input type="password" id="password2" th:field="*{password2}" class="form-control">
    </div>
    <!-- ğŸ“¨ ì´ë©”ì¼ ì…ë ¥ ë° ì¸ì¦ -->
    <div class="mb-3">
      <label for="email" class="form-label">Email</label>
      <input type="email" id="email" th:field="*{email}" class="form-control">
      <button type="button" class="btn btn-secondary" onclick="sendVerificationCode()">ì¸ì¦ ìš”ì²­</button>
      <div th:if="${#fields.hasErrors('email')}" class="alert alert-danger">
        <p th:errors="*{email}"></p>
      </div>
    </div>

    <!-- âœ… ì¸ì¦ ì½”ë“œ ì…ë ¥ -->
    <div class="mb-3">
      <label for="verifyCode" class="form-label">Verification Code</label>
      <input type="text" id="verifyCode" class="form-control">
      <button type="button" id="verifyBtn" class="btn btn-success">ì¸ì¦ í™•ì¸</button>
    </div>

    <!-- ğŸ”’ ì¸ì¦ ì™„ë£Œ ì—¬ë¶€ ì €ì¥ -->
    <input type="hidden" id="verified" name="verified" value="false">

    <button type="submit" class="btn btn-primary" onclick="return checkVerification()">Sign Up</button>
  </form>
</div>


<script>
  function checkVerification() {
    let verified = document.getElementById("verified").value;
    if (verified !== "true") {
      alert("ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì•¼ ê°€ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      return false; // ê°€ì… ë°©ì§€
    }
    return true; // ì •ìƒ ê°€ì… ì§„í–‰
  }

  // âœ… ì¸ì¦ ì½”ë“œ ê²€ì¦ í•¨ìˆ˜ - ì „ì—­ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ìˆ˜ì •
  window.verifyCode = function() {
    let email = document.getElementById("email").value;
    let code = document.getElementById("verifyCode").value;

    if (!email || !code) {
      alert("ì´ë©”ì¼ê³¼ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    fetch("/api/v1/email/verify", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ mail: email, verifyCode: code }),
    })
            .then((response) => response.text())
            .then((data) => {
              alert(data);
              if (data === "ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.") {
                document.getElementById("verified").value = "true";
              }
            })
            .catch((error) => console.error("Error:", error));
  };

  document.addEventListener("DOMContentLoaded", function() {
    let verifyBtn = document.getElementById("verifyBtn");
    if (verifyBtn) {
      verifyBtn.addEventListener("click", verifyCode);
    } else {
      console.error("ğŸš¨ verifyBtnì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }

    window.sendVerificationCode = function() {
      let email = document.getElementById("email").value;
      if (!email) {
        alert("ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      console.log("ğŸ“¤ ì¸ì¦ ìš”ì²­ ì „ì†¡: " + email);

      fetch("/api/v1/email/send", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ mail: email })
      })
              .then(response => response.text())
              .then(data => {
                console.log("âœ… ì„œë²„ ì‘ë‹µ: ", data);
                alert(data);
              })
              .catch(error => {
                console.error("âŒ ì˜¤ë¥˜ ë°œìƒ: ", error);
                alert("ì¸ì¦ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              });
    };
  });
</script>

</body>
