<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
  <title>Sign Up</title>
</head>
<body>
<div layout:fragment="content" class="container my-3">
  <div class="my-3 border-bottom">
    <h1>Sign Up</h1>
  </div>
  <!-- 회원가입 폼 -->
  <form th:action="@{/user/signup}" th:object="${userCreateForm}" method="post">
    <!-- 🛑 아이디 중복 및 기타 글로벌 에러 메시지 -->
    <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger">
      <p th:each="err : ${#fields.globalErrors()}" th:text="${err}"></p>
    </div>

    <div class="mb-3">
      <label for="username" class="form-label">Username</label>
      <input type="text" id="username" th:field="*{username}" class="form-control">

      <!-- 🛑 username 중복 오류 메시지 표시 -->
      <div th:if="${#fields.hasErrors('username')}" class="alert alert-danger">
        <p th:errors="*{username}"></p>
      </div>
    </div>
    <div class="mb-3">
      <label for="password1" class="form-label">Password</label>
      <input type="password" id="password1" th:field="*{password1}" class="form-control">
    </div>
    <div class="mb-3">
      <label for="password2" class="form-label">Confirm Password</label>
      <input type="password" id="password2" th:field="*{password2}" class="form-control">
    </div>
    <!-- 📨 이메일 입력 및 인증 -->
    <div class="mb-3">
      <label for="email" class="form-label">Email</label>
      <input type="email" id="email" th:field="*{email}" class="form-control">
      <button type="button" class="btn btn-secondary" onclick="sendVerificationCode()">인증 요청</button>
      <div th:if="${#fields.hasErrors('email')}" class="alert alert-danger">
        <p th:errors="*{email}"></p>
      </div>
    </div>

    <!-- ✅ 인증 코드 입력 -->
    <div class="mb-3">
      <label for="verifyCode" class="form-label">Verification Code</label>
      <input type="text" id="verifyCode" class="form-control">
      <button type="button" id="verifyBtn" class="btn btn-success">인증 확인</button>
    </div>

    <!-- 🔒 인증 완료 여부 저장 -->
    <input type="hidden" id="verified" name="verified" value="false">

    <button type="submit" class="btn btn-primary" onclick="return checkVerification()">Sign Up</button>
  </form>
</div>


<script>
  function checkVerification() {
    let verified = document.getElementById("verified").value;
    if (verified !== "true") {
      alert("이메일 인증을 완료해야 가입할 수 있습니다.");
      return false; // 가입 방지
    }
    return true; // 정상 가입 진행
  }

  // ✅ 인증 코드 검증 함수 - 전역에서 접근 가능하게 수정
  window.verifyCode = function() {
    let email = document.getElementById("email").value;
    let code = document.getElementById("verifyCode").value;

    if (!email || !code) {
      alert("이메일과 인증 코드를 입력하세요.");
      return;
    }

    fetch("/api/v1/email/verify", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ mail: email, verifyCode: code }),
    })
            .then((response) => response.text())
            .then((data) => {
              alert(data);
              if (data === "인증이 완료되었습니다.") {
                document.getElementById("verified").value = "true";
              }
            })
            .catch((error) => console.error("Error:", error));
  };

  document.addEventListener("DOMContentLoaded", function() {
    let verifyBtn = document.getElementById("verifyBtn");
    if (verifyBtn) {
      verifyBtn.addEventListener("click", verifyCode);
    } else {
      console.error("🚨 verifyBtn이 존재하지 않습니다.");
    }

    window.sendVerificationCode = function() {
      let email = document.getElementById("email").value;
      if (!email) {
        alert("이메일을 입력하세요.");
        return;
      }
      console.log("📤 인증 요청 전송: " + email);

      fetch("/api/v1/email/send", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ mail: email })
      })
              .then(response => response.text())
              .then(data => {
                console.log("✅ 서버 응답: ", data);
                alert(data);
              })
              .catch(error => {
                console.error("❌ 오류 발생: ", error);
                alert("인증 요청 중 오류가 발생했습니다.");
              });
    };
  });
</script>

</body>
